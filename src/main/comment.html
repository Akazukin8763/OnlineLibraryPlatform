<!DOCTYPE html>
<html lang="en">
<head>
    <title>librarySystem</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
        .navbar {
        margin-bottom: 0;
        background-color: #FFA042;
        z-index: 9999;
        border: 0;
        font-size: 12px !important;
        line-height: 1.42857143 !important;
        letter-spacing: 4px;
        border-radius: 0;
        }

        .navbar li a, .navbar .navbar-brand {
        color: #fff !important;
        }

        .navbar-nav li a:hover, .navbar-nav li.active a {
        color: #FFA042 !important;
        background-color: #fff !important;
        }

        .navbar-default .navbar-toggle {
        border-color: transparent;
        color: #fff !important;
        } 
        
        html{
            overflow-x: hidden;
        }
  </style>
  <script type="module">
    import {leaveComment} from "./CheckModule/Comment/comment.js";
    const category_list = new Map([
                ["action_and_adventure", "Action/Adventure"],
                ["alternate_history", "Alternate History"],
                ["anthology", "Anthology"],
                ["chick_lit", "Chick Lit"],
                ["children", "Children"],
                ["classic", "Classic"],
                ["comic_book", "Comic Book"],
                ["coming_of_age", "Coming of Age"],
                ["crime", "Crime"],
                ["drama", "Drama"],
                ["fairytale", "Fairytale"],
                ["fantasy", "Fantasy"],
                ["graphic_novel", "Graphic Novel"],
                ["historical_fiction", "Historical Fiction"],
                ["horror", "Horror"],
                ["mystery", "Mystery"],
                ["paranormal_romance", "Paranormal Romance"],
                ["picture_book", "Picture Book"],
                ["poetry", "Poetry"],
                ["political_thriller", "Political Thriller"],
                ["romance", "Romance"],
                ["satire", "Satire"],
                ["science_fiction", "Science Fiction"],
                ["short_story", "Short Story"],
                ["suspense", "Suspense"],
                ["thriller", "Thriller"],
                ["western", "Western"],
                ["young_adult", "Young Adult"]
            ]);
    var bookTitle = location.search.split("?")[1].split("=")[1];  // ?title=書名
    bookTitle = decodeURI(decodeURI(bookTitle));
    var bookData =[];
    function start(){
        console.log(bookTitle);
        //console.log(decodeURI(bookTitle));
        createInfo(bookTitle,[]);
    }

    function comment(){
        document.location.href='view.html?title='+encodeURI(encodeURI(bookData[0].title));
    }

    function LeaveComment(){
        var yes = confirm('你確定要發表評論嗎');
        if(yes)
            leaveComment(bookData[0].title,document.getElementById("number").value,document.getElementById("text").value);
        console.log(document.getElementById("number").value);
        console.log(document.getElementById("text").value);
        
    }


    function createInfo(__title,__category){
        if (!(__title.length <= 64)) {
        console.log('__title 長度超出限制。');
        return;
        }
        else if (!Array.isArray(__category)) {
            console.log('__category 並非陣列。');
            return;
        }

        if (__title == '') { // 至少一個字元
            __title = '_';
        }
        if (__category.length == 0) { // 都沒有時則全選
            __category = ["action_and_adventure", "alternate_history", "anthology", "chick_lit", "children",
                            "classic", "comic_book", "coming_of_age", "crime", "drama",
                            "fairytale", "fantasy", "graphic_novel", "historical_fiction", "horror",
                            "mystery", "paranormal_romance", "picture_book", "poetry", "political_thriller",
                            "romance", "satire", "science_fiction", "short_story", "suspense",
                            "thriller", "western", "young_adult"];
        }
        $.ajax({
        type: "GET",
        url: "SearchViewModule/Search/searchBook.php",
        dataType: "json",
        data: {
            title: __title,
            category: __category,
        },
        success: function(response) {
            if (response.result) { // 回傳的 json 中含有 result
                var li="";
                bookData = response.result;
                response.result.forEach(book => {
                    console.log("title: " + book.title + ", category: " + book.category);
                    console.log("author: " + book.author + ", publisher: " + book.publisher + ", description: " + book.description);
                    console.log("publish_date: " + book.publish_date + ", arrive_date: " + book.arrive_date);
                    console.log("times: " + book.times)

                    book.books.forEach(bs => {
                        console.log("book_ID: " + bs.book_ID + ", book_status: " + bs.book_status);
                    });
                    book.comments.forEach(bc => {
                        console.log("username: " + bc.username + ", score: " + bc.score + ", comment: " + bc.comment + ", comment_date: " + bc.comment_date);
                    });
                });
                
                li+='<div class="col-sm-4 text-center">';
                li+='<img src="' + bookData[0].image + '.png" style="width: 60%;">';
                li+='<h2>' + bookData[0].title + '</h2><h5>';
                for(var i=0;i<bookData[0].category.length;i++){
                    if(i%2==0){
                        li+='<span class="label label-danger">';
                        li+=category_list.get(bookData[0].category[i]);
                        li+='</span>';
                    }
                    else{
                        li+='<span class="label label-primary">';
                        li+=category_list.get(bookData[0].category[i]);
                        li+='</span>';
                    }
                }
                li+='</h5>';
                li+='<h4><span class="glyphicon glyphicon-user"></span>作者:' + bookData[0].author +'</h4>';
                li+='<h4><span class="glyphicon glyphicon-bookmark"></span>發行商:' + bookData[0].publisher +'</h4>';
                li+='<h5><span class="glyphicon glyphicon-time"></span>發行日期:' +bookData[0].publish_date + '</h5>';
                li+='<h5><span class="glyphicon glyphicon-time"></span>上架日期:' +bookData[0].arrive_date + '</h5>';
                li+='</div><div class="col-sm-8">';
                
                if(bookData[0].comments[0]){
                    for(var i=0;i<bookData[0].comments.length;i++){
                        li+='<div class="col-sm-2 text-center"><img src="https://imgur.com/FuZhgll.png" class="img-circle" height="65" width="65"></div>';
                        li+='<div><h4>' + bookData[0].comments[i].username +'&nbsp;<small><span class="glyphicon glyphicon-time"></span>&nbsp;' + bookData[0].comments[i].comment_date;
                        li+='&nbsp;<span class="glyphicon glyphicon-star"></span>&nbsp;評分:' + bookData[0].comments[i].score +'</small></h4>';
                        li+='<p>' + bookData[0].comments[i].comment + '</p><br></div>';
                    }
                    
                }
                else{
                    li+='<div style="padding-left:50px;">暫無評論</div><br>'
                }
                li+='<div class="text-center col-md-5"><button type="button" class="btn btn-success btn-lg" id="reserve">預約</button></div><div class="text-center col-md-5"><button type="button" class="btn btn-info btn-lg" id="Comment">回到詳細資料</button></div><h1>&nbsp;&nbsp;</h1>';
                li+='<div style="padding-left:50px;"><textarea name="textarea" id="text" rows="10" cols="100">Write something here</textarea></div>';
                li+='<div style="padding-left:50px;">評分: <select id="number"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>&nbsp;&nbsp;';
                li+='<span style="padding-left:560px;"><button type="button" class="btn btn-danger btn-lg" id="comment">發表評論</button></div>';
                document.getElementById("book").innerHTML=li;
                document.getElementById("Comment").addEventListener("click",comment,false);
                document.getElementById("comment").addEventListener("click",LeaveComment,false);
            }
            else {
                console.log(response.errorMsg);
                document.getElementById("book").innerHTML=response.errorMsg;
            }
        },
        error: function(jqXHR) {
            console.log(jqXHR);
        }
    })
    }
    window.addEventListener("load",start,false);

  </script>
</head>
    <body>

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Logo</a>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav navbar-right">
                <li><a href="#about">ABOUT</a></li>
                <li><a href="#services">SERVICES</a></li>
                <li><a href="#portfolio">PORTFOLIO</a></li>
                <li><a href="#pricing">PRICING</a></li>
                <li><a href="#contact">CONTACT</a></li>
                </ul>
            </div>
            </div>
        </nav>

        <div class="row">
            <h1> </h1>
            <br><br><br>
        </div>
        <div class="container-fluid">
            <div class="row content" id="book">
                
            </div>
         </div>

 
    </body>
</html>